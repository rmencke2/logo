<!DOCTYPE html>
<html lang="en">
<head>
  <%- include('partials/head', { title: 'Video to GIF Converter', description: 'Convert your videos to animated GIFs quickly and easily with our free online converter.' }) %>
</head>
<body class="service-page">
  <%- include('partials/header', { currentPage: 'video-to-gif' }) %>

  <main class="service-container">
    <a href="/" class="back-link">&larr; Back to Home</a>

    <div class="service-header">
      <h1 class="service-title">Video to GIF Converter</h1>
      <p class="service-subtitle">Convert your videos to animated GIFs quickly and easily</p>
    </div>

    <div id="authMessage" class="auth-message" style="display: none;">
      <p>Please sign in to use the GIF converter</p>
      <div class="auth-buttons-inline">
        <button class="cta-button primary" onclick="showLoginModal()">Sign In</button>
        <button class="cta-button secondary" onclick="showSignupModal()">Sign Up</button>
      </div>
    </div>

    <div id="toolCard" class="service-card">
      <div class="form-group">
        <label for="videoFileInput">Select Video File</label>
        <input type="file" id="videoFileInput" accept="video/*" />
        <div id="fileInfo" class="file-info"></div>
      </div>

      <button id="convertBtn" class="service-btn" disabled>Convert to GIF</button>

      <div id="progressContainer" class="progress-container">
        <div class="progress-header">
          <div class="spinner"></div>
          <span>Converting video to GIF...</span>
        </div>
        <div class="progress-bar">
          <div id="progressFill" class="progress-fill"></div>
        </div>
        <div id="progressText" class="progress-text">0%</div>
      </div>

      <div id="resultContainer" class="result-container">
        <div class="success-icon">âœ“</div>
        <div class="success-message">Conversion Complete!</div>
        <a id="downloadLink" href="#" download class="download-btn">Download GIF</a>
      </div>

      <div id="errorContainer" class="error-container"></div>
    </div>

    <div class="info-card">
      <h3>Requirements</h3>
      <ul>
        <li>Maximum file size: 500MB</li>
        <li>Supported formats: MP4, AVI, MOV, WebM, MKV, and more</li>
        <li>Output: Animated GIF (10 fps, max width 800px)</li>
        <li>Optimized for web sharing and social media</li>
      </ul>
    </div>
  </main>

  <%- include('partials/footer-loader') %>
  <%- include('partials/auth-scripts') %>

  <script>
    // File input handling
    const videoFileInput = document.getElementById('videoFileInput');
    const convertBtn = document.getElementById('convertBtn');
    const fileInfo = document.getElementById('fileInfo');
    const progressContainer = document.getElementById('progressContainer');
    const resultContainer = document.getElementById('resultContainer');
    const errorContainer = document.getElementById('errorContainer');
    const progressFill = document.getElementById('progressFill');
    const progressText = document.getElementById('progressText');
    const downloadLink = document.getElementById('downloadLink');

    videoFileInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) {
        const fileSizeMB = (file.size / 1024 / 1024).toFixed(2);
        const maxSizeMB = 500;

        const videoMimeTypes = ['video/mp4', 'video/x-msvideo', 'video/quicktime', 'video/webm', 'video/x-matroska'];
        const videoExtensions = ['.mp4', '.avi', '.mov', '.webm', '.mkv', '.wmv', '.3gp', '.flv'];
        const isVideo = videoMimeTypes.includes(file.type) ||
                       videoExtensions.some(ext => file.name.toLowerCase().endsWith(ext));

        if (file.size > maxSizeMB * 1024 * 1024) {
          fileInfo.textContent = `File too large. Maximum size is ${maxSizeMB}MB.`;
          fileInfo.className = 'file-info error';
          convertBtn.disabled = true;
        } else if (!isVideo) {
          fileInfo.textContent = 'Please select a video file (MP4, AVI, MOV, WebM, etc.).';
          fileInfo.className = 'file-info error';
          convertBtn.disabled = true;
        } else {
          fileInfo.textContent = `Selected: ${file.name} (${fileSizeMB} MB)`;
          fileInfo.className = 'file-info success';
          convertBtn.disabled = false;
        }

        resultContainer.classList.remove('active');
        errorContainer.classList.remove('active');
      } else {
        fileInfo.textContent = '';
        fileInfo.className = 'file-info';
        convertBtn.disabled = true;
      }
    });

    // Convert function
    async function convertVideo() {
      const file = videoFileInput.files[0];
      if (!file) {
        errorContainer.textContent = 'Please select a file first.';
        errorContainer.classList.add('active');
        return;
      }

      if (!currentUser) {
        window.location.href = '/?login=true';
        return;
      }

      progressContainer.classList.add('active');
      resultContainer.classList.remove('active');
      errorContainer.classList.remove('active');
      convertBtn.disabled = true;
      progressFill.style.width = '0%';
      progressText.textContent = '0%';

      const formData = new FormData();
      formData.append('video', file);

      try {
        const response = await fetch('/convert-video-to-gif', {
          method: 'POST',
          body: formData,
          credentials: 'include',
        });

        const contentType = response.headers.get('content-type');
        let data;

        if (contentType && contentType.includes('application/json')) {
          data = await response.json();
        } else {
          const text = await response.text();
          console.error('Non-JSON response:', text);
          throw new Error(`Server error: ${response.status} ${response.statusText}`);
        }

        if (!response.ok) {
          throw new Error(data.error || data.message || 'Conversion failed');
        }

        progressContainer.classList.remove('active');
        resultContainer.classList.add('active');
        downloadLink.href = data.downloadUrl;
        downloadLink.download = data.filename || 'converted-video.gif';
      } catch (err) {
        console.error('Conversion error:', err);
        progressContainer.classList.remove('active');
        errorContainer.textContent = err.message || 'An error occurred during conversion. Please try again.';
        errorContainer.classList.add('active');
      } finally {
        convertBtn.disabled = false;
      }
    }

    convertBtn.addEventListener('click', convertVideo);
  </script>
</body>
</html>
