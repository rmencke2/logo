<!DOCTYPE html>
<html lang="en">
<head>
  <%- include('partials/head', { title: 'AVI to MP4 Converter', description: 'Convert your AVI videos to MP4 format quickly and easily with our free online converter.' }) %>
</head>
<body class="service-page">
  <%- include('partials/header', { currentPage: 'video-converter' }) %>

  <main class="service-container">
    <a href="/" class="back-link">&larr; Back to Home</a>

    <div class="service-header">
      <h1 class="service-title">AVI to MP4 Converter</h1>
      <p class="service-subtitle">Convert your AVI videos to MP4 format quickly and easily</p>
    </div>

    <div id="authMessage" class="auth-message" style="display: none;">
      <p>Please sign in to use the video converter</p>
      <div class="auth-buttons-inline">
        <button class="cta-button primary" onclick="showLoginModal()">Sign In</button>
        <button class="cta-button secondary" onclick="showSignupModal()">Sign Up</button>
      </div>
    </div>

    <div id="toolCard" class="service-card">
      <div class="form-group">
        <label for="aviFileInput">Select AVI File</label>
        <input type="file" id="aviFileInput" accept="video/x-msvideo,.avi" />
        <div id="fileInfo" class="file-info"></div>
      </div>

      <button id="convertBtn" class="service-btn" disabled>Convert to MP4</button>

      <div id="progressContainer" class="progress-container">
        <div class="progress-header">
          <div class="spinner"></div>
          <span>Converting video...</span>
        </div>
        <div class="progress-bar">
          <div id="progressFill" class="progress-fill"></div>
        </div>
        <div id="progressText" class="progress-text">0%</div>
      </div>

      <div id="resultContainer" class="result-container">
        <div class="success-icon">âœ“</div>
        <div class="success-message">Conversion Complete!</div>
        <a id="downloadLink" href="#" download class="download-btn">Download MP4</a>
      </div>

      <div id="errorContainer" class="error-container"></div>
    </div>

    <div class="info-card">
      <h3>Requirements</h3>
      <ul>
        <li>Maximum file size: 500MB</li>
        <li>Only AVI files are supported</li>
        <li>Output format: MP4 (H.264 video, AAC audio)</li>
        <li>High quality conversion with minimal compression</li>
      </ul>
    </div>
  </main>

  <%- include('partials/footer-loader') %>
  <%- include('partials/auth-scripts') %>

  <script>
    // File input handling
    const aviFileInput = document.getElementById('aviFileInput');
    const convertBtn = document.getElementById('convertBtn');
    const fileInfo = document.getElementById('fileInfo');
    const progressContainer = document.getElementById('progressContainer');
    const resultContainer = document.getElementById('resultContainer');
    const errorContainer = document.getElementById('errorContainer');
    const progressFill = document.getElementById('progressFill');
    const progressText = document.getElementById('progressText');
    const downloadLink = document.getElementById('downloadLink');

    aviFileInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) {
        const fileSizeMB = (file.size / 1024 / 1024).toFixed(2);
        const maxSizeMB = 500;

        if (file.size > maxSizeMB * 1024 * 1024) {
          fileInfo.textContent = `File too large. Maximum size is ${maxSizeMB}MB.`;
          fileInfo.className = 'file-info error';
          convertBtn.disabled = true;
        } else if (!file.name.toLowerCase().endsWith('.avi')) {
          fileInfo.textContent = 'Only AVI files are supported.';
          fileInfo.className = 'file-info error';
          convertBtn.disabled = true;
        } else {
          fileInfo.textContent = `Selected: ${file.name} (${fileSizeMB} MB)`;
          fileInfo.className = 'file-info success';
          convertBtn.disabled = false;
        }

        resultContainer.classList.remove('active');
        errorContainer.classList.remove('active');
      } else {
        fileInfo.textContent = '';
        fileInfo.className = 'file-info';
        convertBtn.disabled = true;
      }
    });

    // Convert function
    async function convertVideo() {
      const file = aviFileInput.files[0];
      if (!file) {
        errorContainer.textContent = 'Please select a file first.';
        errorContainer.classList.add('active');
        return;
      }

      if (!currentUser) {
        window.location.href = '/?login=true';
        return;
      }

      progressContainer.classList.add('active');
      resultContainer.classList.remove('active');
      errorContainer.classList.remove('active');
      convertBtn.disabled = true;
      progressFill.style.width = '0%';
      progressText.textContent = '0%';

      const formData = new FormData();
      formData.append('video', file);

      try {
        const response = await fetch('/convert-avi-to-mp4', {
          method: 'POST',
          body: formData,
          credentials: 'include',
        });

        const contentType = response.headers.get('content-type');
        let data;

        if (contentType && contentType.includes('application/json')) {
          data = await response.json();
        } else {
          const text = await response.text();
          console.error('Non-JSON response:', text);
          throw new Error(`Server error: ${response.status} ${response.statusText}`);
        }

        if (!response.ok) {
          throw new Error(data.error || data.message || 'Conversion failed');
        }

        progressContainer.classList.remove('active');
        resultContainer.classList.add('active');
        downloadLink.href = data.downloadUrl;
        downloadLink.download = data.filename || 'converted-video.mp4';
      } catch (err) {
        console.error('Conversion error:', err);
        progressContainer.classList.remove('active');
        errorContainer.textContent = err.message || 'An error occurred during conversion. Please try again.';
        errorContainer.classList.add('active');
      } finally {
        convertBtn.disabled = false;
      }
    }

    convertBtn.addEventListener('click', convertVideo);
  </script>
</body>
</html>
