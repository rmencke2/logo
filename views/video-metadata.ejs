<!DOCTYPE html>
<html lang="en">
<head>
  <%- include('partials/head', { title: 'Video Metadata Extractor', description: 'Extract detailed technical information from your video files including codec, resolution, bitrate, and more.' }) %>
  <style>
    .metadata-section {
      background: var(--color-cream);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-md);
      padding: var(--space-lg);
      margin-bottom: var(--space-md);
    }
    .metadata-section h3 {
      font-family: var(--font-ui);
      font-size: 1rem;
      font-weight: 600;
      color: var(--color-terracotta);
      margin-bottom: var(--space-md);
      padding-bottom: var(--space-sm);
      border-bottom: 1px solid var(--color-border);
    }
    .metadata-row {
      display: grid;
      grid-template-columns: 180px 1fr;
      gap: var(--space-md);
      padding: var(--space-sm) 0;
      border-bottom: 1px solid var(--color-border);
    }
    .metadata-row:last-child {
      border-bottom: none;
    }
    .metadata-label {
      font-family: var(--font-ui);
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--color-muted);
    }
    .metadata-value {
      font-family: var(--font-ui);
      font-size: 0.875rem;
      color: var(--color-charcoal);
      word-break: break-word;
    }
    .loading-container {
      display: none;
      margin-top: var(--space-lg);
      padding: var(--space-lg);
      background: var(--color-cream);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-md);
      text-align: center;
    }
    .loading-container.active {
      display: block;
    }
    .metadata-container {
      display: none;
      margin-top: var(--space-lg);
    }
    .metadata-container.active {
      display: block;
    }
    @media (max-width: 600px) {
      .metadata-row {
        grid-template-columns: 1fr;
        gap: var(--space-xs);
      }
      .metadata-label {
        font-weight: 600;
        color: var(--color-terracotta);
      }
    }
  </style>
</head>
<body class="service-page">
  <%- include('partials/header', { currentPage: 'video-metadata' }) %>

  <main class="service-container" style="max-width: 900px;">
    <a href="/" class="back-link">&larr; Back to Home</a>

    <div class="service-header">
      <h1 class="service-title">Video Metadata Extractor</h1>
      <p class="service-subtitle">Extract detailed technical information from your video files</p>
    </div>

    <div id="authMessage" class="auth-message" style="display: none;">
      <p>Please sign in to use the metadata extractor</p>
      <div class="auth-buttons-inline">
        <button class="cta-button primary" onclick="showLoginModal()">Sign In</button>
        <button class="cta-button secondary" onclick="showSignupModal()">Sign Up</button>
      </div>
    </div>

    <div id="toolCard" class="service-card">
      <div class="form-group">
        <label for="videoFileInput">Select Video File</label>
        <input type="file" id="videoFileInput" accept="video/*" />
        <div id="fileInfo" class="file-info"></div>
      </div>

      <button id="extractBtn" class="service-btn" disabled>Extract Metadata</button>

      <div id="loadingContainer" class="loading-container">
        <div class="spinner"></div>
        <span>Extracting metadata...</span>
      </div>

      <div id="metadataContainer" class="metadata-container">
        <!-- Metadata will be displayed here -->
      </div>

      <div id="errorContainer" class="error-container"></div>
    </div>

    <div class="info-card">
      <h3>What You'll Get</h3>
      <ul>
        <li>File information (size, duration, format)</li>
        <li>Video codec and resolution details</li>
        <li>Audio codec and channel information</li>
        <li>Bitrate, frame rate, and technical specs</li>
        <li>Supported formats: MP4, AVI, MOV, WebM, and more</li>
      </ul>
    </div>
  </main>

  <%- include('partials/footer-loader') %>
  <%- include('partials/auth-scripts') %>

  <script>
    // File input handling
    const videoFileInput = document.getElementById('videoFileInput');
    const extractBtn = document.getElementById('extractBtn');
    const fileInfo = document.getElementById('fileInfo');
    const loadingContainer = document.getElementById('loadingContainer');
    const metadataContainer = document.getElementById('metadataContainer');
    const errorContainer = document.getElementById('errorContainer');

    videoFileInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) {
        const fileSizeMB = (file.size / 1024 / 1024).toFixed(2);
        const maxSizeMB = 500;

        const videoMimeTypes = ['video/mp4', 'video/x-msvideo', 'video/quicktime', 'video/webm', 'video/x-matroska'];
        const videoExtensions = ['.mp4', '.avi', '.mov', '.webm', '.mkv', '.wmv', '.3gp', '.flv'];
        const isVideo = videoMimeTypes.includes(file.type) ||
                       videoExtensions.some(ext => file.name.toLowerCase().endsWith(ext));

        if (file.size > maxSizeMB * 1024 * 1024) {
          fileInfo.textContent = `File too large. Maximum size is ${maxSizeMB}MB.`;
          fileInfo.className = 'file-info error';
          extractBtn.disabled = true;
        } else if (!isVideo) {
          fileInfo.textContent = 'Please select a video file (MP4, AVI, MOV, WebM, etc.).';
          fileInfo.className = 'file-info error';
          extractBtn.disabled = true;
        } else {
          fileInfo.textContent = `Selected: ${file.name} (${fileSizeMB} MB)`;
          fileInfo.className = 'file-info success';
          extractBtn.disabled = false;
        }

        metadataContainer.classList.remove('active');
        errorContainer.classList.remove('active');
      } else {
        fileInfo.textContent = '';
        fileInfo.className = 'file-info';
        extractBtn.disabled = true;
      }
    });

    // Extract metadata function
    async function extractMetadata() {
      const file = videoFileInput.files[0];
      if (!file) {
        errorContainer.textContent = 'Please select a file first.';
        errorContainer.classList.add('active');
        return;
      }

      if (!currentUser) {
        window.location.href = '/?login=true';
        return;
      }

      loadingContainer.classList.add('active');
      metadataContainer.classList.remove('active');
      errorContainer.classList.remove('active');
      extractBtn.disabled = true;

      const formData = new FormData();
      formData.append('video', file);

      try {
        const response = await fetch('/extract-video-metadata', {
          method: 'POST',
          body: formData,
          credentials: 'include',
        });

        const contentType = response.headers.get('content-type');
        let data;

        if (contentType && contentType.includes('application/json')) {
          data = await response.json();
        } else {
          const text = await response.text();
          console.error('Non-JSON response:', text);
          throw new Error(`Server error: ${response.status} ${response.statusText}`);
        }

        if (!response.ok) {
          throw new Error(data.error || data.message || 'Extraction failed');
        }

        displayMetadata(data.metadata);
        loadingContainer.classList.remove('active');
        metadataContainer.classList.add('active');
      } catch (err) {
        console.error('Extraction error:', err);
        loadingContainer.classList.remove('active');
        errorContainer.textContent = err.message || 'An error occurred during metadata extraction. Please try again.';
        errorContainer.classList.add('active');
      } finally {
        extractBtn.disabled = false;
      }
    }

    function displayMetadata(meta) {
      const container = metadataContainer;
      container.innerHTML = '';

      // File Information
      const fileSection = document.createElement('div');
      fileSection.className = 'metadata-section';
      fileSection.innerHTML = `
        <h3>File Information</h3>
        <div class="metadata-row">
          <div class="metadata-label">Filename</div>
          <div class="metadata-value">${meta.filename || 'Unknown'}</div>
        </div>
        <div class="metadata-row">
          <div class="metadata-label">File Size</div>
          <div class="metadata-value">${meta.fileSize || 'Unknown'}</div>
        </div>
        <div class="metadata-row">
          <div class="metadata-label">Duration</div>
          <div class="metadata-value">${meta.duration || 'Unknown'}</div>
        </div>
        <div class="metadata-row">
          <div class="metadata-label">Format</div>
          <div class="metadata-value">${meta.format || 'Unknown'}</div>
        </div>
        <div class="metadata-row">
          <div class="metadata-label">Format Name</div>
          <div class="metadata-value">${meta.formatLong || 'Unknown'}</div>
        </div>
        <div class="metadata-row">
          <div class="metadata-label">Bitrate</div>
          <div class="metadata-value">${meta.bitrate || 'Unknown'}</div>
        </div>
      `;
      container.appendChild(fileSection);

      // Video Stream Information
      const videoSection = document.createElement('div');
      videoSection.className = 'metadata-section';
      videoSection.innerHTML = `
        <h3>Video Stream</h3>
        <div class="metadata-row">
          <div class="metadata-label">Codec</div>
          <div class="metadata-value">${meta.videoCodec || 'Unknown'}</div>
        </div>
        <div class="metadata-row">
          <div class="metadata-label">Codec Name</div>
          <div class="metadata-value">${meta.videoCodecLong || 'Unknown'}</div>
        </div>
        <div class="metadata-row">
          <div class="metadata-label">Resolution</div>
          <div class="metadata-value">${meta.videoResolution || 'Unknown'}</div>
        </div>
        <div class="metadata-row">
          <div class="metadata-label">Aspect Ratio</div>
          <div class="metadata-value">${meta.videoAspectRatio || 'Unknown'}</div>
        </div>
        <div class="metadata-row">
          <div class="metadata-label">Frame Rate</div>
          <div class="metadata-value">${meta.videoFrameRate || 'Unknown'}</div>
        </div>
        <div class="metadata-row">
          <div class="metadata-label">Video Bitrate</div>
          <div class="metadata-value">${meta.videoBitrate || 'Unknown'}</div>
        </div>
        <div class="metadata-row">
          <div class="metadata-label">Pixel Format</div>
          <div class="metadata-value">${meta.videoPixelFormat || 'Unknown'}</div>
        </div>
      `;
      container.appendChild(videoSection);

      // Audio Stream Information
      const audioSection = document.createElement('div');
      audioSection.className = 'metadata-section';
      audioSection.innerHTML = `
        <h3>Audio Stream</h3>
        <div class="metadata-row">
          <div class="metadata-label">Codec</div>
          <div class="metadata-value">${meta.audioCodec || 'None'}</div>
        </div>
        <div class="metadata-row">
          <div class="metadata-label">Codec Name</div>
          <div class="metadata-value">${meta.audioCodecLong || 'None'}</div>
        </div>
        <div class="metadata-row">
          <div class="metadata-label">Sample Rate</div>
          <div class="metadata-value">${meta.audioSampleRate || 'None'}</div>
        </div>
        <div class="metadata-row">
          <div class="metadata-label">Channels</div>
          <div class="metadata-value">${meta.audioChannels || 'None'}</div>
        </div>
        <div class="metadata-row">
          <div class="metadata-label">Channel Layout</div>
          <div class="metadata-value">${meta.audioChannelLayout || 'None'}</div>
        </div>
        <div class="metadata-row">
          <div class="metadata-label">Audio Bitrate</div>
          <div class="metadata-value">${meta.audioBitrate || 'None'}</div>
        </div>
      `;
      container.appendChild(audioSection);
    }

    extractBtn.addEventListener('click', extractMetadata);
  </script>
</body>
</html>
