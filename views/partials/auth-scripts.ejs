<script>
  let currentUser = null;

  // Check authentication
  async function checkAuth() {
    const noAuthGate = document.body.dataset.noAuthGate === 'true';
    try {
      const response = await fetch('/auth/me', { credentials: 'include' });
      if (response.ok) {
        const data = await response.json();
        currentUser = data.user;
        if (!noAuthGate) {
          document.getElementById('authMessage')?.style.setProperty('display', 'none');
          document.getElementById('toolCard')?.style.setProperty('display', 'block');
        }
        updateAuthUI();
        if (noAuthGate && currentUser) {
          if (window.location.pathname === '/video-metadata') {
            const pending = sessionStorage.getItem('pendingMetadataDownload');
            if (pending) {
              sessionStorage.removeItem('pendingMetadataDownload');
              const meta = JSON.parse(pending);
              setTimeout(() => typeof triggerMetadataDownload === 'function' && triggerMetadataDownload(meta), 300);
            }
          } else if (window.location.pathname === '/video-converter') {
            const pending = sessionStorage.getItem('pendingVideoDownload');
            if (pending) {
              sessionStorage.removeItem('pendingVideoDownload');
              const { url, filename } = JSON.parse(pending);
              setTimeout(() => {
                const a = document.createElement('a');
                a.href = url;
                a.download = filename || 'converted-video.mp4';
                a.style.display = 'none';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
              }, 300);
            }
          }
        }
        return true;
      } else {
        currentUser = null;
        if (!noAuthGate) {
          document.getElementById('authMessage')?.style.setProperty('display', 'block');
          document.getElementById('toolCard')?.style.setProperty('display', 'none');
        }
        updateAuthUI();
        return false;
      }
    } catch (err) {
      console.error('Auth check error:', err);
      currentUser = null;
      if (!noAuthGate) {
        document.getElementById('authMessage')?.style.setProperty('display', 'block');
        document.getElementById('toolCard')?.style.setProperty('display', 'none');
      }
      updateAuthUI();
      return false;
    }
  }

  // Update header auth UI
  async function updateAuthUI() {
    try {
      const response = await fetch('/auth/me', { credentials: 'include' });
      if (response.ok) {
        const data = await response.json();
        const user = data.user;
        document.getElementById('authButtons').style.display = 'none';
        document.getElementById('userInfo').style.display = 'flex';
        document.getElementById('userName').textContent = user.name || user.email;
        document.getElementById('userAvatar').textContent = (user.name || user.email || 'U').charAt(0).toUpperCase();
        if (user.avatarUrl) {
          document.getElementById('userAvatar').style.backgroundImage = `url(${user.avatarUrl})`;
          document.getElementById('userAvatar').style.backgroundSize = 'cover';
          document.getElementById('userAvatar').textContent = '';
        }
      } else {
        document.getElementById('authButtons').style.display = 'flex';
        document.getElementById('userInfo').style.display = 'none';
      }
    } catch (err) {
      console.error('Auth check error:', err);
    }
  }

  function logout() {
    fetch('/auth/logout', { method: 'POST', credentials: 'include' })
      .then(() => {
        window.location.href = '/';
      })
      .catch(err => console.error('Logout error:', err));
  }

  // Show login modal (redirect to homepage if not available)
  function showLoginModal() {
    window.location.href = '/?login=true';
  }

  // Show signup modal (redirect to homepage if not available)
  function showSignupModal() {
    window.location.href = '/?signup=true';
  }

  // Initialize auth
  checkAuth();
</script>
